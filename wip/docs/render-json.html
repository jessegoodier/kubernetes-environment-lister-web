<!DOCTYPE html>
<html>
    <head>
        <!-- Set the title of the page -->
        <title>JSON to Table</title>
        <!-- Set the favicon of the page -->
        <link rel="icon" href="https://raw.githubusercontent.com/jessegoodier/kubernetes-environment-lister-web/main/docs/favicon.ico" type="image/x-icon">
        <!-- Link to the CSS stylesheet -->
        <link rel="stylesheet" type="text/css" href="css/styles.css">
    </head>
    <body>
        <script>
                // Fetch the JSON data
                fetch("index.json")
                    .then((response) => response.json()) // Parse the response as JSON
                    .then((data) => {
                        // Get the body element
                        const body = document.getElementsByTagName("body")[0];

                        // Iterate over each namespace in the data
                        data.Namespaces.forEach((namespace) => {
                            // Create a new heading for the namespace
                            const heading = document.createElement("h2");
                            heading.textContent = "Namespace: " + namespace.Namespace + " (" + namespace.Pods.length + " pods)";
                            body.appendChild(heading);

                            // Create a new list for the ingresses
                            const ingressList = document.createElement("ul");

                            // Check if the namespace has any ingresses
                            if (namespace.Ingress && namespace.Ingress.length > 0) {
                                // Iterate over each ingress in the namespace
                                namespace.Ingress.forEach((ingress) => {
                                    // Create a new list item for the ingress
                                    const ingressItem = document.createElement("li");
                                    ingressItem.innerHTML = "<a href=\"https://" + ingress.Host + ingress.Path + "\">" + ingress.Host + ingress.Path + "</a>";
                                    // Append the list item to the list
                                    ingressList.appendChild(ingressItem);
                                });
                            } else {
                                // Create a new list item for the "No ingresses" message
                                const ingressItem = document.createElement("li");
                                ingressItem.innerHTML = "<p>No ingresses</p>";
                                // Append the list item to the list
                                ingressList.appendChild(ingressItem);
                            }

                            // Append the list to the body
                            body.appendChild(ingressList);

                            // Create a new table for the namespace
                            const table = document.createElement("table");
                            table.innerHTML = `
                                <thead>
                                    <tr>
                                        <th>Pod</th>
                                        <th>Container</th>
                                        <th>Image</th>
                                        <th>Status</th>
                                        <th>StartedAt</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            `;
                            body.appendChild(table);

                            // Get the table body
                            const tableBody = table.getElementsByTagName("tbody")[0];

                            // Iterate over each pod in the namespace
                            namespace.Pods.forEach((pod) => {
                                // Iterate over each container in the pod
                                pod.Containers.forEach((container) => {
                                    // Insert a new row in the table
                                    const newRow = tableBody.insertRow();

                                    // Initialize the reason variable and get the status of the container
                                    var reason = "";
                                    var status = Object.keys(container.Status)[0];

                                    // Get the JSON of the status and add line breaks after each comma and brace
                                    var reason = JSON.stringify(container.Status, null, 2);
                                    reason = reason.replace(/,/g, ',<br>');
                                    reason = reason.replace(/}/g, '}<br>');
                                    reason = reason.replace(/{/g, '{<br>');

                                    // Get the start time of the container
                                    startedAt = container.Status[status].startedAt;

                                    // Initialize the row with the pod name, container name, and image
                                    thisRow = `
                                        <td>${pod.Pod}</td>
                                        <td>${container.ContainerName}</td>
                                        <td>${container.Image}</td>`

                                    // If the container is running or terminated, add the status and start time to the row
                                    if (status === "running") {
                                        thisRow += `<td>${status}</td>
                                                                <td>${startedAt}</td>`
                                    } else if (status === "terminated") {
                                        thisRow += `<td><div class="tooltip"><u>${status}</u><span class="tooltiptext">${reason}</span></div></td>
                                                                <td>-</td>`
                                    } else {
                                        // If the container has any other status, add the status (with a tooltip for the reason) and a placeholder for the start time to the row
                                        thisRow += `<td bgcolor="darkred"><div class="tooltip"><u>${status}</u><span class="tooltiptext">${reason}</span></div></td>
                                                                <td>-</td>`
                                    }

                                    // Set the HTML of the new row to the constructed row
                                    newRow.innerHTML = thisRow;
                                });
                            });
                        });
                    });
            </script>
            <script>
                // Get all tooltip elements
                const tooltips = document.querySelectorAll('.tooltip');

                // Iterate over each tooltip
                tooltips.forEach(tooltip => {
                    // Add an event listener for the mouseover event
                    tooltip.addEventListener('mouseover', () => {
                        // When the mouse is over the tooltip, make the tooltip text visible
                        tooltip.querySelector('.tooltiptext').style.visibility = 'visible';
                    });

                    // Add an event listener for the mouseout event
                    tooltip.addEventListener('mouseout', () => {
                        // When the mouse is not over the tooltip, make the tooltip text hidden
                        tooltip.querySelector('.tooltiptext').style.visibility = 'hidden';
                    });
                });
            </script>
    </body>
</html>